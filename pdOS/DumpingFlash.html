<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dumping what flash we can - pd-platform</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../Overview.html">Introduction</a></li><li class="chapter-item expanded "><a href="../binary/index.html"><strong aria-hidden="true">1.</strong> Game Binary Internals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../binary/GameOfLife.html"><strong aria-hidden="true">1.1.</strong> Game of Life, at a Glance</a></li><li class="chapter-item expanded "><a href="../binary/Building.html"><strong aria-hidden="true">1.2.</strong> Building Life</a></li><li class="chapter-item expanded "><a href="../binary/BinaryStructure.html"><strong aria-hidden="true">1.3.</strong> Binary Structure</a></li></ol></li><li class="chapter-item expanded "><a href="../console/index.html"><strong aria-hidden="true">2.</strong> Game Console</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../console/ValidMemory.html"><strong aria-hidden="true">2.1.</strong> Valid Memory</a></li><li class="chapter-item expanded "><a href="../console/peripherals.html"><strong aria-hidden="true">2.2.</strong> Connected Peripherals</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> Game Console Overview</div></li></ol></li><li class="chapter-item expanded "><a href="../pdOS/index.html"><strong aria-hidden="true">3.</strong> pd-OS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pdOS/DumpingFlash.html" class="active"><strong aria-hidden="true">3.1.</strong> Dumping what flash we can</a></li><li class="chapter-item expanded "><a href="../pdOS/TriagingUserFlashDump.html"><strong aria-hidden="true">3.2.</strong> Triaging User Mode flash dump</a></li><li class="chapter-item expanded "><a href="../pdOS/SearchingForFreeRTOSCode.html"><strong aria-hidden="true">3.3.</strong> Searching for FreeRTOS code</a></li></ol></li><li class="chapter-item expanded "><a href="../errata/index.html"><strong aria-hidden="true">4.</strong> Errata</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../errata/TriagingHardFloatDisassmbly.html"><strong aria-hidden="true">4.1.</strong> Triaging Hard Float Disassembly</a></li><li class="chapter-item expanded "><a href="../errata/FPv5MeetWorld.html"><strong aria-hidden="true">4.2.</strong> FPv5 meets Worl</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">pd-platform</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/lockbox/pd-platform" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dumping-flash"><a class="header" href="#dumping-flash">Dumping Flash</a></h1>
<p>From <a href="../console/ValidMemory.html"><code>Valid Memory</code></a> we know that flash starts
at <code>0x08000000</code> and goes until <code>0x080FFFFF</code>. So lets write up a quick C stub
to dump it over serial, and a python script to pickup the dump.</p>
<p>See pd-usb for details but the high level is that you just need to connect
with baud rate <code>115200</code> to the play.date, the ID's (just in case you want custom
udev rules for mitm serial or something similar, or its not under <code>/dev/ttyACM0</code>) are:</p>
<ul>
<li>Vendor ID: <code>0x1331</code></li>
<li>Product ID: <code>0x5740</code></li>
</ul>
<p>The general algorithm is very simple:</p>
<blockquote>
<p>Note:</p>
<p>Flash has a default value of <code>0xffffffff</code>, so I used shortcut logic to
wait until 100 were read in a row, no need to waste time, though the baud
rate is 115200 so at least it moves pretty quick in this case. Many times
you need to do this it is prohibitively slow to read + dump flash though.</p>
</blockquote>
<pre><code class="language-c">static void dump_flash(PlaydateAPI *pd)
{
    uint32_t addr;
    uint32_t value = 0;
    uint32_t default_value = 0; // number of consecutive ``0xffffffff``

    // pattern so python script to pickup the dump knows we're printing
    println(&quot;0x%08x, 0x%08x, dump_start:\r\n&quot;, FLASH_START, FLASH_END);

    // iterate over each word in flash, and dump it
    for (addr = FLASH_START; addr &lt;= FLASH_END; addr += 0x4)
    {
        value = *((uint32_t *)addr);

        // check if ``0xffffffff``
        if (value == 0xffffffff)
        {
            default_value++;
            
            // if there are 100 ``0xffffffff`` in a row then quit,
            // assume that we hit the end of the flash memory used
            if (default_value &gt;= 100)
                break;
        }
        else
        {
            default_value = 0;
        }

        println(&quot;0x%08x: 0x%08x\r\n&quot;, addr, value);
    }
}
</code></pre>
<h3 id="a-couple-speed-bumps-along-the-way"><a class="header" href="#a-couple-speed-bumps-along-the-way">A couple speed bumps along the way:</a></h3>
<blockquote>
<p>So I've been using the docs as given in the <a href="">awesome playdate</a> repo,
which started crashing things a bunch when reading from flash <code>0x08000000</code>
until <code>0x08050000</code> which then let me dump until the end of flash, so I
went back through the FCC filing photos to see the actual MCU onboard.</p>
<p>The actual MCU is <a href="https://www.st.com/en/microcontrollers-microprocessors/stm32f746ie.html">STM23f746ie</a>, which really doesn't change
anything wrt what docs to use. So for the moment I'm still stumped why it's
crashing attempting to read flash below <code>0x08050000</code>.</p>
<p>Then I found <a href="https://github.com/STMicroelectronics/STM32CubeF7/blob/master/Drivers/STM32F7xx_HAL_Driver/Src/stm32f7xx_hal_flash_ex.c#L914">this</a>,</p>
</blockquote>
<p>Step 1: get the typedef for the System Flash Registers:</p>
<pre><code class="language-c">// github STM32CubeF7/Drivers/CMSIS/Device/ST/STM32F7xx/Include/stm32f7xx.h
typedef struct
{
  __IO uint32_t ACR;      /*!&lt; FLASH access control register,     Address offset: 0x00 */
  __IO uint32_t KEYR;     /*!&lt; FLASH key register,                Address offset: 0x04 */
  __IO uint32_t OPTKEYR;  /*!&lt; FLASH option key register,         Address offset: 0x08 */
  __IO uint32_t SR;       /*!&lt; FLASH status register,             Address offset: 0x0C */
  __IO uint32_t CR;       /*!&lt; FLASH control register,            Address offset: 0x10 */
  __IO uint32_t OPTCR;    /*!&lt; FLASH option control register ,    Address offset: 0x14 */
  __IO uint32_t OPTCR1;   /*!&lt; FLASH option control register 1 ,  Address offset: 0x18 */
} FLASH_TypeDef;
</code></pre>
<p>Well so we're still crashing, heck. So they probably are using the Memory Protection Unit.
At least we could dump user flash. Time to try to dump some more stuff and move on.</p>
<p>See if we can dump OTP memory, though it might also be protected.
It starts at <code>0x1FF0F000</code> and is (16 * 64) bytes (16 banks):</p>
<pre><code class="language-c">#define OTP_START 0x1FF0F000UL
#define OTP_END OTP_START + (16 * 64)

static void dump_otp(PlaydateAPI *pd)
{
    uint32_t addr;
    uint32_t value = 0;

    println(&quot;0x%08x, 0x%08x, dump_start:\r\n&quot;, OTP_START, OTP_END);

    for (addr = OTP_START; addr &lt;= OTP_END; addr += 0x4)
    {
        value = *((uint32_t *)addr);

        // print value
        println(&quot;%08x\r\n&quot;, value);
    }
}
</code></pre>
<p>F.</p>
<p>Still crashing, tho duh we're still not privileged.</p>
<p>Time to go about this a different way - what if their kernel doesn't do usermode pointer validation?</p>
<p>Lets try again:</p>
<pre><code class="language-c">static void write_kmem_to_file(PlaydateAPI *pd, uint32_t base, uint32_t size, const char *fname)
{
    SDFile *file = pd-&gt;file-&gt;open(fname, kFileWrite);

    // make sure we can actually write to a file
    if (file == NULL)
    {
        WRITE_FSTRING(pd, &quot;%s was unable to be opened because:\n\t%s&quot;, fname, pd-&gt;file-&gt;geterr());
        return;   
    }

    // tell the kernel to write to the file
    if ((-1 == pd-&gt;file-&gt;write(file, (void*)base, size)) == 1)
    {
        WRITE_FSTRING(pd, &quot;ERROR when writing to file:\n\t%s&quot;, pd-&gt;file-&gt;geterr());
        return;
    }

    // close the file
    pd-&gt;file-&gt;close(file);
}


static void dump_otp(PlaydateAPI *pd)
{
    WRITE_FSTRING(pd, &quot;Attempting to read memory from %p to %p&quot;, OTP_START, OTP_END);
    write_kmem_to_file(pd, OTP_START, OTP_END - OTP_START, &quot;otp_mem.bin&quot;);
}
</code></pre>
<p>Still crashing, though after looking back through the re notes I noticed</p>
<ol>
<li>they do use OTP (cool) and</li>
<li>once upon a time they <a href="https://github.com/jaames/playdate-reverse-engineering/blob/main/usb/usb.md#unlock">didn't validate the pointers</a> (or something to that effect - most likely they MPU wasn't actually enabled).</li>
</ol>
<p>Upon further attempts I'm assuming that any memory accessed by the kernel for
the process is limited to the program stack / heap as the following did not work.</p>
<ul>
<li>start of flash <code>0x08000000</code></li>
<li>known kernel addresses (from forcing crashes) <code>0x0803xxxx</code></li>
<li>known user space addresses (from pd api) <code>0x0805xxxx</code></li>
<li>system registers</li>
<li>OTP memory</li>
</ul>
<p>So after perusing the forums a <a href="https://devforum.play.date/t/file-open-crashes-on-device-c-api/9841/11">bit</a> it's using (as i actually assumed
right for once) <a href="https://www.freertos.org/">FreeeRTOS</a>. And now it looks like
the new play.date versions are using (working) MPU builds, rude.</p>
<p>Oh well, got user mode dumps, time to RE a bit.</p>
<p>Next: <a href="./TriagingUserFlashDump.html">Triaging User Flash Dump</a></p>
<p><img src="https://media.tenor.com/jdFD8PpUK64AAAAC/skeletor-running-away.gif" alt="skeletor.gif" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pdOS/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../pdOS/TriagingUserFlashDump.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pdOS/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../pdOS/TriagingUserFlashDump.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
