<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Triaging User Mode flash dump - pd-platform</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../Overview.html">Introduction</a></li><li class="chapter-item expanded "><a href="../binary/index.html"><strong aria-hidden="true">1.</strong> Game Binary Internals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../binary/GameOfLife.html"><strong aria-hidden="true">1.1.</strong> Game of Life, at a Glance</a></li><li class="chapter-item expanded "><a href="../binary/Building.html"><strong aria-hidden="true">1.2.</strong> Building Life</a></li><li class="chapter-item expanded "><a href="../binary/BinaryStructure.html"><strong aria-hidden="true">1.3.</strong> Binary Structure</a></li></ol></li><li class="chapter-item expanded "><a href="../console/index.html"><strong aria-hidden="true">2.</strong> Game Console</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../console/ValidMemory.html"><strong aria-hidden="true">2.1.</strong> Valid Memory</a></li><li class="chapter-item expanded "><a href="../console/peripherals.html"><strong aria-hidden="true">2.2.</strong> Connected Peripherals</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> Game Console Overview</div></li></ol></li><li class="chapter-item expanded "><a href="../pdOS/index.html"><strong aria-hidden="true">3.</strong> pd-OS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pdOS/DumpingFlash.html"><strong aria-hidden="true">3.1.</strong> Dumping what flash we can</a></li><li class="chapter-item expanded "><a href="../pdOS/TriagingUserFlashDump.html" class="active"><strong aria-hidden="true">3.2.</strong> Triaging User Mode flash dump</a></li><li class="chapter-item expanded "><a href="../pdOS/SearchingForFreeRTOSCode.html"><strong aria-hidden="true">3.3.</strong> Searching for FreeRTOS code</a></li></ol></li><li class="chapter-item expanded "><a href="../errata/index.html"><strong aria-hidden="true">4.</strong> Errata</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../errata/TriagingHardFloatDisassmbly.html"><strong aria-hidden="true">4.1.</strong> Triaging Hard Float Disassembly</a></li><li class="chapter-item expanded "><a href="../errata/FPv5MeetWorld.html"><strong aria-hidden="true">4.2.</strong> FPv5 meets Worl</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">pd-platform</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/lockbox/pd-platform" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="triaging-user-mode-dump"><a class="header" href="#triaging-user-mode-dump">Triaging User Mode Dump</a></h1>
<p>Before pigeon-holing too hard on something in particular it's good to go over
the goals of what you're doing and what a decent path forward might actually be.
This is especially important for things like reversing an entire OS / bare metal
system where you have interrupts firing all over the place, a ton of third party
code, vendor SDK code, and the actual target code you care about.</p>
<p>SO, in the spirit of &quot;seeing where we're at&quot;, we can take a step back and go over
the goals again:</p>
<ol>
<li>Figure out how to talk to Wi-Fi</li>
<li>Figure out the limits of being &quot;unprivileged&quot;</li>
<li>Kernel mode dump (disclaimer, its not hard - but most likely unnecessary for Wi-Fi)</li>
<li>Reverse all the things</li>
</ol>
<p>So focusing on task 1, there are a few sub tasks that will probably lead to most of the
others getting done in the process.</p>
<ul>
<li>Label all the public SDK functions</li>
<li>Label FreeRTOS functions</li>
<li>If there are any in user space, find the memfault functions</li>
<li>Find each of the running threads</li>
<li>Find the thread that talks to the ESP wifi chip on board</li>
<li>Figure out which IPC method they use to control that thread</li>
</ul>
<p>The high level workflow for the intial triage of user space is going to roughly follow:</p>
<ul>
<li>look @ <code>PlaydateSimulator.debug</code> for type information we can <em>maybe</em> use (
or at least get a reference for their programming paradigms)</li>
<li>make a playdate game to dump addresses for all of the documented API's
<ul>
<li>im assuming that some scoreboard api has some Wi-Fi things under the hood
will probably get us close</li>
</ul>
</li>
<li>look at <code>FreeRTOS</code> source to figure out what some of the syscalls are, then work
up to the pd api functions</li>
<li>if there's 0 progress:
<ul>
<li>we can reverse some of the season games to figure out what's going on
(but that's cheating :p )</li>
<li>look for hardcoded <a href="https://docs.espressif.com/projects/esp-at/en/latest/esp32/AT_Command_Set/Basic_AT_Commands.html">AT commands</a>, tried and true &quot;grep flag&quot; basically always works,
but is suuuper anti-climactic</li>
</ul>
</li>
</ul>
<p>So without further ado, let's jump in</p>
<h1 id="babys-first-binary-dump"><a class="header" href="#babys-first-binary-dump">Baby's first binary dump</a></h1>
<p>We'll use <a href="https://binary.ninja">binary.ninja</a> to reverse the code on the playdate,
note that we're in thumb2 mode and our starting offset is not 0. So when we first
open the binary dump we should see this:</p>
<p><img src="./binary_ninja_first_open.png" alt="first_open.png" /></p>
<p>Make sure to change the image base address to <code>0x08050000</code>.</p>
<p>Also switch it to disassembly so things look clearer - binary ninja is not best suited
for non standard targets, and all disassemblers are notoriously bad at arm / thumb / vfp,
so we'll take it easy on it. Notice how all of the functions aren't named, and things
are all over the place (duh its a binary dump). We have some work to do.</p>
<h2 id="step-1---applying-debug-types"><a class="header" href="#step-1---applying-debug-types">Step 1 - Applying debug types</a></h2>
<p>The first step is going to be installing the dwarf debug info plugin that
vector35 published, then <em>ugh</em> restarting binary ninja. But afterwards we can now import
debug info from the shipped external <code>PlaydateSimulator.debug</code> file from the SDK.</p>
<p><img src="./dwarf_debug_plugin.png" alt="./import_debug_info" /></p>
<p>And now all the types are applied we can export the types to a header file.</p>
<p>Turning the provided <code>dwarf2</code> debug file into a header we get <a href="">this</a>. We can
import the header into binary ninja with some extra flags [as documented below],
and then we will have those as needed hen we find stuff. Note that we probably
won't use those types much in user space but better safe than sorry. Also now
that binary ninja literally <a href="https://binary.ninja/2023/01/18/3.3-the-bytes-must-flow.html#import--export-header-files">just stabilized</a>
the header / type importing I figured I'd go ahead and give it a whirl.</p>
<h2 id="step-15---importing-the-sdk-c-types"><a class="header" href="#step-15---importing-the-sdk-c-types">Step 1.5 - Importing the SDK C Types</a></h2>
<p>The more useful thing to import into binary ninja for looking at user space is
going to be the <code>C_API</code> (specifically the <code>pd_api.h</code> header). Note that
binary ninja uses <a href="https://binary.ninja/2022/10/28/3.2-released.html#default-to-clang-type-parser">clang type parser</a>
for their header importing, so now we can import the headers with the arguments
from the compiler like so:</p>
<p>Import selection is here:</p>
<p><img src="./import_headers_select.png" alt="./import_headers_select.png" /></p>
<p>Then add the compiler options:</p>
<p><img src="./import_headers_1.png" alt="./import_headers_1.png" /></p>
<p>And it worked (this time), though it failed the first time I tried to, and reading the
<a href="https://docs.binary.ninja/guide/type.html#import-header-file">documentation</a> shows that
there are extra arguents necessary to add the system types, so you might need to add those.
On my machine it looked like:</p>
<p><img src="./import_headers_2.png" alt="./import_headers_2.png" /></p>
<p>Now we can directly use the types directly (instead of hand-jamming them) for the next step:</p>
<h2 id="step-2---dumping-the-api-addresses"><a class="header" href="#step-2---dumping-the-api-addresses">Step 2 - Dumping the API addresses</a></h2>
<p>The Playdate API is super nice and user friendly, and is half the reason I started
writing all this stuff up. So now that we've imported all the Playdate <code>C_API</code>
types and functions we need to dump the addresses from a real device so we can
properly label them in the memory dump we're reversing in binary ninja.</p>
<p>So to do this we're going to dump all of the tables in the main <code>PlaydateAPI</code>
struct (each of the struct members is a pointer to anotherb struct of
function pointers), and afterwards we will use that to label the corresponding
functions in binary ninja.</p>
<p>Corresponding code snippet:</p>
<pre><code class="language-C">/**
 * \brief macro to dump pointer tables, looks super fancy but all its really doing
 * is:
 *   - starting a json object for the table with the provided name, address, and size.
 *   - dumping each word as 4 zero padded bytes in a hex string as a part of the data
 *     array in the json object
 */
#define LOG_TABLE(__pd, __name, __sz, __ptr)                                                \
    do                                                                                      \
    {                                                                                       \
        WRITE_FCONSOLE(__pd,                                                                \
                       &quot;{\&quot;name\&quot;: \&quot;%s\&quot;, \&quot;address\&quot;: \&quot;%p\&quot;, \&quot;size\&quot;: %d, \&quot;data\&quot;: [&quot;, \
                       __name,                                                              \
                       (void *)__ptr,                                                       \
                       __sz);                                                               \
        for (int i = 0; i &lt; __sz / 4; i++)                                                  \
        {                                                                                   \
            WRITE_FCONSOLE(__pd, &quot;\&quot;%08x\&quot;,&quot;, *(((uint32_t *)__ptr) + i));                  \
        }                                                                                   \
        WRITE_FCONSOLE(__pd, &quot;%s&quot;, &quot;]}&quot;);                                                   \
    } while (0)

/**
 * \brief dumps a jsonl of symbols to the console
 */
static void log_addresses(PlaydateAPI *pd)
{
    LOG_TABLE(pd, &quot;pd-&gt;system&quot;, sizeof(struct playdate_sys), pd-&gt;system);
    LOG_TABLE(pd, &quot;pd-&gt;file&quot;, sizeof(struct playdate_file), pd-&gt;file);
    LOG_TABLE(pd, &quot;pd-&gt;graphics&quot;, sizeof(struct playdate_graphics), pd-&gt;graphics);
    LOG_TABLE(pd, &quot;pd-&gt;sprite&quot;, sizeof(struct playdate_sprite), pd-&gt;sprite);
    LOG_TABLE(pd, &quot;pd-&gt;display&quot;, sizeof(struct playdate_display), pd-&gt;display);
    LOG_TABLE(pd, &quot;pd-&gt;sound&quot;, sizeof(struct playdate_sound), pd-&gt;sound);
    LOG_TABLE(pd, &quot;pd-&gt;lua&quot;, sizeof(struct playdate_lua), pd-&gt;lua);
    LOG_TABLE(pd, &quot;pd-&gt;json&quot;, sizeof(struct playdate_json), pd-&gt;json);
    LOG_TABLE(pd, &quot;pd-&gt;scoreboards&quot;, sizeof(struct playdate_scoreboards), pd-&gt;scoreboards);
    WRITE_FSTRING(pd, &quot;Wrote tables to console&quot;, &quot;&quot;);
}
</code></pre>
<p>This will output json for each pointer table, and give us most of the information
we need without doing toooo much work in C. (initially I started dumping the name
of each function as well but that started to be too much in C).</p>
<p>Also I started to get lazy, so we'll just look at the playdate simulator console
and look at the output to line it up with the api headers and binary ninja.</p>
<p>Each function table is going to get dumped in order, so we can just walk down the
list of functions in each struct and directly apply things in binry ninja.</p>
<p>Snapshot:</p>
<p><img src="./dumping_api_addresses.png" alt="./dumping_api_addresses.png" /></p>
<p>Cool, we can go back to binary ninja and apply the <code>playdate_sys</code> struct type
to the address listed, and hopefully that will just label all the functions for
us like I've previously done in ghidra.</p>
<p><img src="./pd_sys_type_fail.png" alt="./pd_sys_type_fail.png" /></p>
<p>Excuse me tf. The endianness is wrong for the addresses :facepalm:. Joy.
Well I don't know how to fix that (after digging around a bit I couldn't figure it
out, not going to worry about it though since it doesn't really break anything and
you can manually add cross-references - the answer is probably defining a custom data
section that is big endian).</p>
<p>What we can do is manually create the references to all the functions, and manually
define functions at the necessary addresses (note because we are in thumb mode
when we create addresses at the odd addresses binary ninja will correctly create
the function at the odd address - 1, see <a href="https://stackoverflow.com/questions/28669905/what-is-the-difference-between-the-arm-thumb-and-thumb-2-instruction-encodings">here</a>
for computer engineers getting carried away). Cool let's look at realloc and see if it
worked:</p>
<p><img src="./realloc_fail.png" alt="./realloc_fail" /></p>
<p>Ummm, great another bug. Failing to disassemble. Fantastic. After repo-ing ghidra, objdump,
capstone and ida, I'm thinking it's probably an issue with a hard float instructions (it
always is lmao). </p>
<p>The hard float abi used for this mcu is <a href="https://developer.arm.com/documentation/ddi0489/b/floating-point-unit/about-the-fpu">FPv5</a>.
So looks like we're going to need to make some MR's (or PR's in github land). yay.</p>
<p>See <a href="./TriagingHardFloatDisassmbly.html">Triaging Hard Float Disassembly</a> for more.</p>
<p>In the mean time we can finish labelling all the functions and see where we stand.</p>
<p>Next: <a href="./SearchingForFreeRTOSCode.html">Searching for FreeRTOS code</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../pdOS/DumpingFlash.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../pdOS/SearchingForFreeRTOSCode.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../pdOS/DumpingFlash.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../pdOS/SearchingForFreeRTOSCode.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
