<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Valid Memory - pd-platform</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../Overview.html">Introduction</a></li><li class="chapter-item expanded "><a href="../binary/index.html"><strong aria-hidden="true">1.</strong> Game Binary Internals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../binary/GameOfLife.html"><strong aria-hidden="true">1.1.</strong> Game of Life, at a Glance</a></li><li class="chapter-item expanded "><a href="../binary/Building.html"><strong aria-hidden="true">1.2.</strong> Building Life</a></li><li class="chapter-item expanded "><a href="../binary/BinaryStructure.html"><strong aria-hidden="true">1.3.</strong> Binary Structure</a></li></ol></li><li class="chapter-item expanded "><a href="../console/index.html"><strong aria-hidden="true">2.</strong> Game Console</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../console/ValidMemory.html" class="active"><strong aria-hidden="true">2.1.</strong> Valid Memory</a></li><li class="chapter-item expanded "><a href="../console/peripherals.html"><strong aria-hidden="true">2.2.</strong> Connected Peripherals</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> Game Console Overview</div></li></ol></li><li class="chapter-item expanded "><a href="../pdOS/index.html"><strong aria-hidden="true">3.</strong> pd-OS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pdOS/DumpingFlash.html"><strong aria-hidden="true">3.1.</strong> Dumping what flash we can</a></li><li class="chapter-item expanded "><a href="../pdOS/TriagingUserFlashDump.html"><strong aria-hidden="true">3.2.</strong> Triaging User Mode flash dump</a></li><li class="chapter-item expanded "><a href="../pdOS/SearchingForFreeRTOSCode.html"><strong aria-hidden="true">3.3.</strong> Searching for FreeRTOS code</a></li></ol></li><li class="chapter-item expanded "><a href="../errata/index.html"><strong aria-hidden="true">4.</strong> Errata</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../errata/TriagingHardFloatDisassmbly.html"><strong aria-hidden="true">4.1.</strong> Triaging Hard Float Disassembly</a></li><li class="chapter-item expanded "><a href="../errata/FPv5MeetWorld.html"><strong aria-hidden="true">4.2.</strong> FPv5 meets Worl</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">pd-platform</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/lockbox/pd-platform" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="finding-valid-memory"><a class="header" href="#finding-valid-memory">Finding Valid Memory</a></h1>
<p>To determine valid memory address ranges in RAM, we can start with a couple of easy no-crash-no-risk methods before just yolo touching different regions to see
if the play.date crashes or not</p>
<p>First we're going to try</p>
<ul>
<li>Using the <code>PlaydateAPI</code> address to get valid regions</li>
<li>Using allocator memory to get a valid region</li>
<li>Get the stack memory</li>
<li>Look at function addresses to see where valid code space is</li>
<li>Walk the stack</li>
</ul>
<h2 id="using-the-playdateapi-address"><a class="header" href="#using-the-playdateapi-address">Using the PlaydateAPI address</a></h2>
<p>Using the pointer provided to our event handler we can mask off the lower bits
and find which RAM bank the heap with the playdate object is in (or stack address / flash address
if its not stored on the heap, TBD)</p>
<p>Using some quick n dirty C we can dump the address to the screen like below:</p>
<p><img src="./api_address.gif" alt="api_address.gif" /></p>
<p>C snippet:</p>
<pre><code class="language-c">static void log_addresses(PlaydateAPI *pd)
{
    char * api_base;
    char * pd_address;

    // create the statements
    pd-&gt;system-&gt;formatString(&amp;api_base, &quot;API Base Address: %p&quot;, (uint32_t)pd &amp; 0xf0000000);
    pd-&gt;system-&gt;formatString(&amp;pd_address, &quot;PD API Address: %p&quot;, pd);    

    // write the statements
    write_line(pd, api_base);
    write_line(pd, pd_address);

    // free the statements
    FREE(api_base);
    FREE(pd_address);
}
</code></pre>
<p>What this tells us is that the pd api is allocated in SRAM (system SRAM
starts at <code>0x20000000</code> as per <a href="https://www.st.com/resource/en/reference_manual/dm00124865-stm32f75xxx-and-stm32f74xxx-advanced-arm-based-32-bit-mcus-stmicroelectronics.pdf">docs section 2.3</a>).
Cool, now that we have some progress, we're going to dump some more
addresses to see what we're working with.</p>
<h2 id="using-more-addresses"><a class="header" href="#using-more-addresses">Using more addresses</a></h2>
<p>Now we're going to still use the pd api address, but now we're going to
allocate something on the heap and use that address as well, and allocate
something on the stack and use that address (Note that the stack is setup
to be only <code>61800</code> bytes a la <code>C_API/buildsupport/*.cmake</code> and
<code>C_API/Examples/*/Makefile</code>).</p>
<p>So, lets see what we got:</p>
<p><img src="./addresses.png" alt="addresses" /></p>
<p>corresponding snippet:</p>
<pre><code class="language-c">static void log_addresses(PlaydateAPI *pd)
{
    char * api_base;
    char * pd_address;
    char * heap_obj;
    char * heap_base;
    char * stack_obj;
    char * stack_base;
    char * code_ptr;

    // create the statements
    pd-&gt;system-&gt;formatString(&amp;api_base, &quot;API Base Address: %p&quot;, (uint32_t)pd &amp; 0xf0000000);
    pd-&gt;system-&gt;formatString(&amp;pd_address, &quot;PD API Address: %p&quot;, pd);
    pd-&gt;system-&gt;formatString(&amp;heap_base, &quot;Heap Base Address: %p&quot;, ((uint32_t)api_base &amp; 0xf0000000));
    pd-&gt;system-&gt;formatString(&amp;heap_obj, &quot;Heap Address: %p&quot;, api_base);
    pd-&gt;system-&gt;formatString(&amp;stack_base, &quot;Stack Base Address: %p&quot;, ((uint32_t)&amp;api_base &amp; 0xf0000000));
    pd-&gt;system-&gt;formatString(&amp;stack_obj, &quot;Stack Address: %p&quot;, &amp;api_base);
    pd-&gt;system-&gt;formatString(&amp;code_ptr, &quot;&amp;formatString: %p&quot;, pd-&gt;system-&gt;formatString);

    // write the statements
    write_line(pd, api_base);
    write_line(pd, pd_address);
    write_line(pd, heap_base);
    write_line(pd, heap_obj);
    write_line(pd, stack_base);
    write_line(pd, stack_obj);
    write_line(pd, code_ptr);

    // free the statements
    FREE(api_base);
    FREE(pd_address);
    FREE(heap_base);
    FREE(heap_obj);
    FREE(stack_base);
    FREE(stack_obj);
    FREE(code_ptr);
}
</code></pre>
<p>Cool, so this looks like we have a (so far) deterministic stack address
(<code>0x2003807c</code>) for the pd api handle, and that the heap objects we
allocate during games are going to be allocated immediately after the
game code (remember that the game is mapped to <code>0x60000000</code>) in ram.
Additionally this shows us that the flash region beng used for code
(specifically the flash region that <code>pd-&gt;system-&gt;formatString</code> is in)
is the flash bank that starts at <code>0x8000000</code>.</p>
<p>Flash bank table for reference (<a href="https://www.st.com/resource/en/reference_manual/dm00124865-stm32f75xxx-and-stm32f74xxx-advanced-arm-based-32-bit-mcus-stmicroelectronics.pdf">section 3.3.1</a>):</p>
<p><img src="./flash_blocks.png" alt="flash_blocks.png" /></p>
<p>So what we can glean from this table (and the fact that we can run code on it)
is that we have permission to access the memory and execute it (haven't seen
many things that allow execute only permissions), and that the entire flash
region is from address <code>0x08000000</code> to <code>0x080FFFFF</code>). So we can probably just
dump all that code right now if we wanted to, BUT we still have a fun exercise
comming up.</p>
<h2 id="walking-the-stack"><a class="header" href="#walking-the-stack">Walking the stack</a></h2>
<p>This is a fun exercise of walking the stack, intuitively we will imagine
the stack growing down, as the addresses decrease the more items you add.
Note that because we are executing exclusively in <code>Thumb2</code> mode
the calling convention / ABI that will be used on the play.date is
documented <a href="https://developer.arm.com/documentation/dui0041/c/Thumb-Procedure-Call-Standard/About-the-Thumb-Procedure-Call-Standard">here</a>.</p>
<p>You should probably skim this real quick before continuing.</p>
<p>Note this fun highlight from the docs:</p>
<blockquote>
<p><code>fp</code> is usually not used in Thumb state</p>
</blockquote>
<p>And note the register names they use:</p>
<table><thead><tr><th>Register</th><th>TPCS name</th><th>TPCS role</th></tr></thead><tbody>
<tr><td>r0</td><td>a1</td><td>argument 1/scratch register/result</td></tr>
<tr><td>r1</td><td>a2</td><td>argument 2/scratch register/result</td></tr>
<tr><td>r2</td><td>a3</td><td>argument 3/scratch register/result</td></tr>
<tr><td>r3</td><td>a4</td><td>argument 4/scratch register/result</td></tr>
<tr><td>r4</td><td>v1</td><td>register variable</td></tr>
<tr><td>r5</td><td>v2</td><td>register variable</td></tr>
<tr><td>r6</td><td>v3</td><td>register variable</td></tr>
<tr><td>r7</td><td>v4/wr</td><td>register variable/work register in function entry/exit</td></tr>
<tr><td>r8</td><td>(v5)</td><td>(ARM v5 register, no defined role in Thumb)</td></tr>
<tr><td>r9</td><td>(v6)</td><td>(ARM v6 register, no defined role in Thumb)</td></tr>
<tr><td>r10</td><td>sl (v7)</td><td>stack limit</td></tr>
<tr><td>r11</td><td>fp (v8)</td><td>frame pointer (usually not used in Thumb state)</td></tr>
<tr><td>r12</td><td>(ip)</td><td>(ARM ip register, no defined role in Thumb. May be used as a temporary register on Thumb function entry/exit.)</td></tr>
<tr><td>r13</td><td>sp</td><td>stack pointer (full descending stack)</td></tr>
<tr><td>r14</td><td>lr</td><td>link register</td></tr>
<tr><td>r15</td><td>pc</td><td>program counter</td></tr>
</tbody></table>
<p>They double down on the no-frame-pointer-use when discussing <a href="https://developer.arm.com/documentation/dui0041/c/Thumb-Procedure-Call-Standard/TPCS-definition/Control-arrival">control arrival</a>:</p>
<pre><code>At the instant when control arrives at the target function:

    - pc contains the address of an entry point to the target function.

    - lr contains the value to restore to pc on exit from the function
    (the return link value, see The stack backtrace data structure).

    - sp points at or above the current stack limit. If the limit is
    explicit, sp will point at least 256 bytes above it (see The 
    Stack).

    - If the function is built to use a frame pointer register, fp 
    contains 0 or points to the most recently created stack backtrace 
    structure (see The stack backtrace data structure). This is not 
    usual in Thumb state.

    - The space between sp and the stack limit must be readable and 
    writable memory which the called function can use as temporary 
    workspace, and overwrite with any values before the function 
    returns (see The Stack).
</code></pre>
<p>Note that argument passing is more or less standard for a computer
architecture, (well at least nothing is too out of the ordinary as
specified in the <a href="https://developer.arm.com/documentation/dui0041/c/Thumb-Procedure-Call-Standard/TPCS-definition/Data-representation-and-argument-passing">argument passing</a> document, though there
are many real-world cases where that is not honored, not too worried about that here though).</p>
<pre><code>At the instant control arrives at the target function, the argument 
list is allocated as follows:

    - the first four argument words (or fewer if there are fewer than 
    four argument words remaining in the argument list) are in machine 
    registers a1-a4

    - the remainder of the argument list (if any) is in memory, at the 
    location addressed by sp and higher addressed words thereafter.

    - A floating-point value is treated as one, two, or three integer 
    values, as appropriate to its precision. The TPCS does not support 
    the passing or returning of floating-point values in ARM 
    floating-point registers.
</code></pre>
<p>And last but not least, <a href="https://developer.arm.com/documentation/dui0041/c/Thumb-Procedure-Call-Standard/TPCS-definition/Control-return">control return</a></p>
<pre><code>When the return link value for a function call is placed in the pc:

    - sp, fp, sl, v6, v5, and v1-v4 contain the same values as they 
    did at the instant of control arrival. If the function returns a 
    simple value of size one word or less, the value is contained in 
    a1.

    - If the function returns a simple value of size one word or less, 
    then the value must be in a1. A language implementation is not 
    obliged to consider all single-word values simple. See Non-simple 
    value return.

    - If the function returns a simple floating-point value, the value 
    is encoded in a1, {a1, a2}, or {a1, a2, a3}, depending on its 
    precision.
</code></pre>
<p>SO, time to cry. basically because by default thumb mode omit's the frame
pointer theres not going to be frame's to jump back to. Instead of doing
some fun tricks and heuristics to figure out what our frames are, we're just
going to dump flash. Because I don't want to think that hard.</p>
<p>But we know that we can read the flash section, and we know that the
onboard <code>SRAM</code> is used for the stack, and that the <code>0x60000000</code> region that
our code gets mapped to is where our heap is.</p>
<p>Next: <a href="../pdOS/DumpingFlash.html">Dumping Flash</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../console/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../console/peripherals.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../console/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../console/peripherals.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
